
@page "/passwords"
@using System.Linq.Expressions
@using Microsoft.AspNetCore.Components.QuickGrid

@if (passwords is null || !passwords.Any())
{
    <div class="d-flex justify-content-center">
        <div id="loadingIndicator" class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <button class="btn btn-primary" @onclick="TogglePasswords">Toggle Password Visibility</button>

    <div class="text-center overflow-auto m-3">
        <QuickGrid Items="@pagedPasswords" Class="table table-striped table-bordered">
            <PropertyColumn Property="@(m => m.Title)" Sortable="true">
                <HeaderTemplate>
                    <button @onclick="@(() => SortData(PasswordColumns.Title))" class="btn btn-primary">
                        Sort @GetSortIcon(PasswordColumns.Title)
                    </button>
                    <TextInputFilter Value="@TitleFilter" ValueChanged="@((value) => { TitleFilter = value; FilterPasswords(); })" PlaceHolder="Filter by Title" />
                </HeaderTemplate>
            </PropertyColumn>

            @* <PropertyColumn Property="@(m => m.Username)" Sortable="true">
                <HeaderTemplate>
                    <button @onclick="@(() => SortData(PasswordColumns.Username))" class="btn btn-primary">
                        Sort @GetSortIcon(PasswordColumns.Username)
                    </button>
                    <TextInputFilter Value="@UsernameFilter" ValueChanged="@((value) => { UsernameFilter = value; FilterPasswords(); })" PlaceHolder="Filter by Username" />
                </HeaderTemplate>
            </PropertyColumn> *@

            <TemplateColumn Context="password" Title="Username" Class="align-middle">
                @if (editingUsernameId == password.Id)
                {
                    <input @bind="password.Username" class="form-control" />
                }
                else
                {
                    <span>@password.Username</span>
                }
                <button @onclick="@(() => ToggleEdit(password.Id, nameof(password.Username)))" class="btn btn-secondary">
                    @(editingUsernameId == password.Id ? "Save" : "Edit")
                </button>
            </TemplateColumn>

            <PropertyColumn Property="@(m => m.Password)" Sortable="true">
                <HeaderTemplate>
                    <button @onclick="@(() => SortData(PasswordColumns.Password))" class="btn btn-primary">
                        Sort @GetSortIcon(PasswordColumns.Password)
                    </button>
                    <TextInputFilter Value="@PasswordFilter" ValueChanged="@((value) => { PasswordFilter = value; FilterPasswords(); })" PlaceHolder="Filter by Password" />
                </HeaderTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@(m => m.CreatedAt)" Sortable="true">
                <HeaderTemplate>
                    <button @onclick="@(() => SortData(PasswordColumns.CreatedAt))" class="btn btn-primary">
                        Sort @GetSortIcon(PasswordColumns.CreatedAt)
                    </button>
                    <TextInputFilter Value="@CreatedAtFilter" ValueChanged="@((value) => { CreatedAtFilter = value; FilterPasswords(); })" PlaceHolder="Filter by Created At" />
                </HeaderTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@(m => m.LastUpdatedAt)" Sortable="true">
                <HeaderTemplate>
                    <button @onclick="@(() => SortData(PasswordColumns.LastUpdatedAt))" class="btn btn-primary">
                        Sort @GetSortIcon(PasswordColumns.LastUpdatedAt)
                    </button>
                    <TextInputFilter Value="@LastUpdatedAtFilter" ValueChanged="@((value) => { LastUpdatedAtFilter = value; FilterPasswords(); })" PlaceHolder="Filter by Detections" />
                </HeaderTemplate>
            </PropertyColumn>
        </QuickGrid>
    </div>
    <CustomPagination CurrentPage="@currentPage" TotalPages="@totalPages" OnPageChanged="@HandlePageChange" />


    @* be able add, remove, update password accounts *@


}
 

@code {

    private int? editingUsernameId = null;
    private int? editingPasswordId = null;

    private void ToggleEdit(int id, string field)
    {
        if (field == nameof(PasswordAccountDTO.Username))
        {
            editingUsernameId = (editingUsernameId == id) ? null : id;
        }
        else if (field == nameof(PasswordAccountDTO.Password))
        {
            editingPasswordId = (editingPasswordId == id) ? null : id;
        }
    }
 
    private enum PasswordColumns
    {
        Title,
        Username,
        Password,
        CreatedAt,
        LastUpdatedAt,
    }
 
    private PasswordColumns passwordColumns;
 
    private IQueryable<PasswordAccountDTO> passwords {get; set;}
 
    private HttpClient httpClient { get;set; }

    private bool hidePasswords = true;

    private async Task TogglePasswords()
    {
        hidePasswords = !hidePasswords;
        Console.WriteLine(hidePasswords);
        if (hidePasswords)
        {
            passwords = passwords.Select(p => new PasswordAccountDTO {
                Title = p.Title,
                Id = p.Id,
                UserId = p.UserId,
                Username = p.Username,
                Password = "*****",
                CreatedAt = p.CreatedAt,
                LastUpdatedAt = p.LastUpdatedAt,
            }).AsQueryable();
        }
        else
        {
            passwords = (await httpClient.GetFromJsonAsync<IEnumerable<PasswordAccountDTO>>("api/PasswordManager/passwords")).AsQueryable();
        }

        UpdatePagedPasswords();
    }
   
    protected override async Task OnInitializedAsync()
    {
        httpClient = httpClientFactory.CreateClient(Constants.HTTP_CLIENT);
        passwords = (await httpClient.GetFromJsonAsync<IEnumerable<PasswordAccountDTO>>("api/PasswordManager/passwords")).Select(p => new PasswordAccountDTO {
            Title = p.Title,
            Id = p.Id,
            UserId = p.UserId,
            Username = p.Username,
            Password = "*****",
            CreatedAt = p.CreatedAt,
            LastUpdatedAt = p.LastUpdatedAt,
        }).AsQueryable();
 
        UpdatePagedPasswords();
    }
 
    private IQueryable<PasswordAccountDTO> pagedPasswords; // Paginated data
   
    // Filter properties
    private string TitleFilter {get;set;} = string.Empty;
    private string UsernameFilter {get;set;} = string.Empty;
    private string PasswordFilter {get;set;} = string.Empty;
    private string CreatedAtFilter {get;set;} = string.Empty;
    private string LastUpdatedAtFilter {get;set;} = string.Empty;
 
    private IQueryable<PasswordAccountDTO> filteredPasswords => passwords
        .Where(p => (
                string.IsNullOrWhiteSpace(TitleFilter) &&
                string.IsNullOrWhiteSpace(UsernameFilter) &&
                string.IsNullOrWhiteSpace(PasswordFilter) &&
                string.IsNullOrWhiteSpace(CreatedAtFilter) &&
                string.IsNullOrWhiteSpace(LastUpdatedAtFilter))
                || (!string.IsNullOrWhiteSpace(TitleFilter) && p.Title.ToString().Contains(TitleFilter, StringComparison.OrdinalIgnoreCase))
        || (!string.IsNullOrWhiteSpace(UsernameFilter) && p.Username.Contains(UsernameFilter, StringComparison.OrdinalIgnoreCase))
        || (!string.IsNullOrWhiteSpace(PasswordFilter) && p.Password.Contains(PasswordFilter, StringComparison.OrdinalIgnoreCase))
        || (!string.IsNullOrWhiteSpace(CreatedAtFilter) && p.CreatedAt.ToString() == CreatedAtFilter)
        || (!string.IsNullOrWhiteSpace(LastUpdatedAtFilter) && p.LastUpdatedAt.ToString() == LastUpdatedAtFilter)
            )
        .AsQueryable();
 
    private int currentPage = 1;
    private const int pageSize = 5; // Number of items per page
    private int totalPages => (int) Math.Ceiling((double) filteredPasswords.Count() / pageSize);
 
    private void FilterPasswords()
    {
        currentPage = 1;
        UpdatePagedPasswords();
    }
 
    // Handle page change event
    private void HandlePageChange(int newPage)
    {
        currentPage = newPage;
        UpdatePagedPasswords();
    }
 
    private PasswordColumns sortColumn; // The column currently being sorted
    private bool sortAscending = true; // Ascending or descending sort
 
    private void SortData(PasswordColumns columnName)
    {
        if (sortColumn == columnName)
        {
            sortAscending = !sortAscending; // Toggle sort direction
        }
        else
        {
            sortColumn = columnName; // Set new column to sort
            sortAscending = true; // Default to ascending
        }
 
        UpdatePagedPasswords();
    }
 
    private void UpdatePagedPasswords()
    {
        pagedPasswords = filteredPasswords.Skip((currentPage - 1) * pageSize).Take(pageSize).AsQueryable();
 
        // Apply sorting
        pagedPasswords = sortAscending
            ? pagedPasswords.OrderBy(GetSortExpression())
            : pagedPasswords.OrderByDescending(GetSortExpression());
 
    }
 
    private Expression<Func<PasswordAccountDTO, object>> GetSortExpression()
    {
        // Return the appropriate expression based on the column being sorted
        return sortColumn switch
        {
            PasswordColumns.Title => p => p.Title,
            PasswordColumns.Username => p => p.Username,
            PasswordColumns.Password => p => p.Password,
            PasswordColumns.CreatedAt => p => p.CreatedAt,
            PasswordColumns.LastUpdatedAt => p => p.LastUpdatedAt,
            _ => p => p.Id // Default sort
        };
    }
 
    private string GetSortIcon(PasswordColumns columnName)
    {
        return sortColumn == columnName ? (sortAscending ? "↑" : "↓") : string.Empty; // Return an up or down arrow based on sorting
    }
}